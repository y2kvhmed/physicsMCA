<!DOCTYPE html>
<html>
<head>
    <title>üîß Complete Supabase Diagnostic & Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .test { 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 5px; 
            border-left: 4px solid #ccc; 
        }
        .success { 
            background-color: #d4edda; 
            border-left-color: #28a745; 
            color: #155724; 
        }
        .error { 
            background-color: #f8d7da; 
            border-left-color: #dc3545; 
            color: #721c24; 
        }
        .warning { 
            background-color: #fff3cd; 
            border-left-color: #ffc107; 
            color: #856404; 
        }
        .info { 
            background-color: #d1ecf1; 
            border-left-color: #17a2b8; 
            color: #0c5460; 
        }
        button { 
            margin: 5px; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .login-form { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 5px; 
            margin: 20px 0; 
        }
        .login-form input { 
            width: 100%; 
            padding: 10px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 3px; 
        }
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 10px 0; 
        }
        .data-table th, .data-table td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        .data-table th { 
            background-color: #f2f2f2; 
        }
        .spinner { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3498db; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            animation: spin 2s linear infinite; 
            display: inline-block; 
            margin-right: 10px; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Complete Supabase Diagnostic & Fix Tool</h1>
        <p>This tool will test and fix all Supabase functionality including login, database access, and data operations.</p>
        
        <div class="section">
            <h2>üöÄ Quick Actions</h2>
            <button class="btn-primary" onclick="runFullDiagnostic()">Run Full Diagnostic</button>
            <button class="btn-success" onclick="testLogin()">Test Login System</button>
            <button class="btn-warning" onclick="fixAllIssues()">Auto-Fix Issues</button>
            <button class="btn-danger" onclick="clearResults()">Clear Results</button>
        </div>

        <div class="section">
            <h2>üîê Login Test</h2>
            <div class="login-form">
                <h3>Test Admin Login</h3>
                <input type="text" id="adminEmail" placeholder="Email" value="Admin">
                <input type="password" id="adminPassword" placeholder="Password" value="Adm1n1strat0r">
                <button class="btn-primary" onclick="testAdminLogin()">Test Admin Login</button>
                
                <h3>Test Database Login</h3>
                <input type="text" id="dbEmail" placeholder="Email" value="test@example.com">
                <input type="password" id="dbPassword" placeholder="Password" value="password123">
                <button class="btn-primary" onclick="testDatabaseLogin()">Test DB Login</button>
            </div>
        </div>

        <div id="results"></div>
        
        <div class="section">
            <h2>üìä Live Data View</h2>
            <button class="btn-primary" onclick="loadAllData()">Load All Data</button>
            <div id="dataView"></div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://pxirgvkbrykkdutqxxhf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4aXJndmticnlra2R1dHF4eGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDY1NjEsImV4cCI6MjA3NTQ4MjU2MX0.90BO0hVXJszO35lMgTKLiSrbkZ1gPP1q9zgZLiUxA5w';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const results = document.getElementById('results');
        const dataView = document.getElementById('dataView');
        
        function addResult(test, type, message, details = '') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            div.innerHTML = `
                <strong>${icon} ${test}:</strong> ${message}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function addSpinner(test) {
            const div = document.createElement('div');
            div.className = 'test info';
            div.id = `spinner-${test.replace(/\s+/g, '-')}`;
            div.innerHTML = `<div class="spinner"></div><strong>Testing ${test}...</strong>`;
            results.appendChild(div);
            return div;
        }

        function removeSpinner(test) {
            const spinner = document.getElementById(`spinner-${test.replace(/\s+/g, '-')}`);
            if (spinner) spinner.remove();
        }

        async function runFullDiagnostic() {
            clearResults();
            addResult('Diagnostic Started', 'info', 'Running comprehensive Supabase diagnostic...');
            
            await testEnvironment();
            await testConnection();
            await testAuthentication();
            await testDatabaseTables();
            await testStorageBuckets();
            await testRLSPolicies();
            await testDataOperations();
            
            addResult('Diagnostic Complete', 'success', 'All tests completed. Check results above.');
        }

        async function testEnvironment() {
            const spinner = addSpinner('Environment');
            
            try {
                addResult('Environment Variables', 'success', 
                    `URL: ${SUPABASE_URL ? '‚úÖ Set' : '‚ùå Missing'}, Key: ${SUPABASE_ANON_KEY ? '‚úÖ Set' : '‚ùå Missing'}`);
                
                addResult('Supabase Client', 'success', 'Client initialized successfully');
                
            } catch (error) {
                addResult('Environment', 'error', 'Failed to initialize', error.message);
            } finally {
                removeSpinner('Environment');
            }
        }

        async function testConnection() {
            const spinner = addSpinner('Connection');
            
            try {
                const { data, error } = await supabase
                    .from('schools')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    addResult('Connection Test', 'error', 'Failed to connect', error.message);
                } else {
                    addResult('Connection Test', 'success', 'Successfully connected to Supabase');
                }
            } catch (error) {
                addResult('Connection Test', 'error', 'Connection failed', error.message);
            } finally {
                removeSpinner('Connection');
            }
        }

        async function testAuthentication() {
            const spinner = addSpinner('Authentication');
            
            try {
                // Test getting current session
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    addResult('Auth Session', 'warning', 'Session error (may be normal)', error.message);
                } else {
                    addResult('Auth Session', 'success', 
                        session ? 'Active session found' : 'No active session (normal)');
                }

                // Test auth endpoints
                const response = await fetch(`${SUPABASE_URL}/auth/v1/settings`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    addResult('Auth Endpoints', 'success', 'Auth system accessible');
                } else {
                    addResult('Auth Endpoints', 'error', `HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                addResult('Authentication', 'error', 'Auth test failed', error.message);
            } finally {
                removeSpinner('Authentication');
            }
        }

        async function testDatabaseTables() {
            const tables = ['schools', 'app_users', 'assignments', 'study_materials', 'submissions', 'enrollments', 'classes'];
            
            for (const table of tables) {
                const spinner = addSpinner(`Table ${table}`);
                
                try {
                    const { data, error } = await supabase
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        addResult(`Table: ${table}`, 'error', error.message);
                    } else {
                        addResult(`Table: ${table}`, 'success', 
                            `Accessible (${data ? data.length : 0} records in sample)`);
                    }
                } catch (error) {
                    addResult(`Table: ${table}`, 'error', error.message);
                } finally {
                    removeSpinner(`Table ${table}`);
                }
            }
        }

        async function testStorageBuckets() {
            const buckets = ['study-materials', 'submissions', 'videos'];
            
            for (const bucket of buckets) {
                const spinner = addSpinner(`Storage ${bucket}`);
                
                try {
                    const { data, error } = await supabase.storage
                        .from(bucket)
                        .list('', { limit: 1 });
                    
                    if (error) {
                        addResult(`Storage: ${bucket}`, 'error', error.message);
                    } else {
                        addResult(`Storage: ${bucket}`, 'success', 
                            `Accessible (${data ? data.length : 0} files in root)`);
                    }
                } catch (error) {
                    addResult(`Storage: ${bucket}`, 'error', error.message);
                } finally {
                    removeSpinner(`Storage ${bucket}`);
                }
            }
        }

        async function testRLSPolicies() {
            const spinner = addSpinner('RLS Policies');
            
            try {
                // Test anonymous access to schools (should work)
                const { data: schoolsData, error: schoolsError } = await supabase
                    .from('schools')
                    .select('id, name')
                    .limit(3);
                
                if (schoolsError) {
                    addResult('RLS: Schools', 'warning', 'May be blocked by RLS', schoolsError.message);
                } else {
                    addResult('RLS: Schools', 'success', 
                        `Schools accessible (${schoolsData ? schoolsData.length : 0} records)`);
                }

                // Test anonymous access to users (should be restricted)
                const { data: usersData, error: usersError } = await supabase
                    .from('app_users')
                    .select('id, email')
                    .limit(1);
                
                if (usersError) {
                    addResult('RLS: Users', 'success', 'Properly protected by RLS', usersError.message);
                } else {
                    addResult('RLS: Users', 'warning', 
                        'Users table may be too open', `${usersData ? usersData.length : 0} records accessible`);
                }

            } catch (error) {
                addResult('RLS Policies', 'error', 'RLS test failed', error.message);
            } finally {
                removeSpinner('RLS Policies');
            }
        }

        async function testDataOperations() {
            const spinner = addSpinner('Data Operations');
            
            try {
                // Test read operations
                const { data: schools, error: schoolsError } = await supabase
                    .from('schools')
                    .select('*')
                    .limit(5);
                
                if (schoolsError) {
                    addResult('Data Read', 'error', 'Failed to read schools', schoolsError.message);
                } else {
                    addResult('Data Read', 'success', 
                        `Successfully read ${schools ? schools.length : 0} schools`);
                }

                // Test if we can see any users (for login testing)
                const { data: users, error: usersError } = await supabase
                    .from('app_users')
                    .select('id, email, role')
                    .limit(3);
                
                if (!usersError && users && users.length > 0) {
                    addResult('Available Users', 'info', 
                        `Found ${users.length} users for testing: ${users.map(u => u.email).join(', ')}`);
                } else {
                    addResult('Available Users', 'warning', 
                        'No users visible (may need authentication)', usersError?.message || 'No data');
                }

            } catch (error) {
                addResult('Data Operations', 'error', 'Data test failed', error.message);
            } finally {
                removeSpinner('Data Operations');
            }
        }

        async function testLogin() {
            clearResults();
            addResult('Login Test Started', 'info', 'Testing login functionality...');
            
            await testAdminLogin();
            await testDatabaseLogin();
        }

        async function testAdminLogin() {
            const spinner = addSpinner('Admin Login');
            
            try {
                const email = document.getElementById('adminEmail').value;
                const password = document.getElementById('adminPassword').value;
                
                addResult('Admin Login Attempt', 'info', `Testing with ${email}/${password}`);
                
                // Test hardcoded admin credentials
                if (email === 'Admin' && password === 'Adm1n1strat0r') {
                    addResult('Admin Login', 'success', 'Hardcoded admin credentials work');
                    
                    // Simulate storing session
                    localStorage.setItem('test_admin_session', JSON.stringify({
                        id: 'test-admin-id',
                        email: 'admin@test.com',
                        name: 'Test Administrator',
                        role: 'admin'
                    }));
                    
                    addResult('Admin Session', 'success', 'Admin session stored in localStorage');
                } else {
                    addResult('Admin Login', 'error', 'Invalid admin credentials');
                }
                
            } catch (error) {
                addResult('Admin Login', 'error', 'Login test failed', error.message);
            } finally {
                removeSpinner('Admin Login');
            }
        }

        async function testDatabaseLogin() {
            const spinner = addSpinner('Database Login');
            
            try {
                const email = document.getElementById('dbEmail').value;
                const password = document.getElementById('dbPassword').value;
                
                addResult('Database Login Attempt', 'info', `Testing with ${email}/${password}`);
                
                // First try Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (authData.user && !authError) {
                    addResult('Supabase Auth', 'success', 'Successfully authenticated with Supabase Auth');
                    
                    // Try to get user from app_users table
                    const { data: userData, error: userError } = await supabase
                        .from('app_users')
                        .select('*')
                        .eq('id', authData.user.id)
                        .single();
                    
                    if (userData) {
                        addResult('User Profile', 'success', `Found user profile: ${userData.name} (${userData.role})`);
                    } else {
                        addResult('User Profile', 'warning', 'Auth successful but no profile found', userError?.message);
                    }
                    
                    // Sign out
                    await supabase.auth.signOut();
                    
                } else {
                    addResult('Supabase Auth', 'warning', 'Supabase Auth failed, trying direct DB lookup', authError?.message);
                    
                    // Try direct database lookup
                    const { data: directUser, error: directError } = await supabase
                        .from('app_users')
                        .select('*')
                        .eq('email', email)
                        .single();
                    
                    if (directUser) {
                        if (directUser.password_hash === password) {
                            addResult('Direct DB Login', 'success', `Found user: ${directUser.name} (${directUser.role})`);
                        } else {
                            addResult('Direct DB Login', 'error', 'User found but password mismatch');
                        }
                    } else {
                        addResult('Direct DB Login', 'error', 'User not found in database', directError?.message);
                    }
                }
                
            } catch (error) {
                addResult('Database Login', 'error', 'Login test failed', error.message);
            } finally {
                removeSpinner('Database Login');
            }
        }

        async function loadAllData() {
            const spinner = addSpinner('Loading Data');
            dataView.innerHTML = '<h3>Loading all data...</h3>';
            
            try {
                const tables = ['schools', 'app_users', 'assignments', 'study_materials'];
                let html = '';
                
                for (const table of tables) {
                    const { data, error } = await supabase
                        .from(table)
                        .select('*')
                        .limit(10);
                    
                    html += `<h4>${table.toUpperCase()} (${data ? data.length : 0} records)</h4>`;
                    
                    if (error) {
                        html += `<p class="error">Error: ${error.message}</p>`;
                    } else if (data && data.length > 0) {
                        html += '<table class="data-table">';
                        html += '<tr>' + Object.keys(data[0]).map(key => `<th>${key}</th>`).join('') + '</tr>';
                        data.forEach(row => {
                            html += '<tr>' + Object.values(row).map(val => 
                                `<td>${val !== null ? String(val).substring(0, 50) : 'NULL'}</td>`
                            ).join('') + '</tr>';
                        });
                        html += '</table>';
                    } else {
                        html += '<p>No data found</p>';
                    }
                }
                
                dataView.innerHTML = html;
                
            } catch (error) {
                dataView.innerHTML = `<p class="error">Failed to load data: ${error.message}</p>`;
            } finally {
                removeSpinner('Loading Data');
            }
        }

        async function fixAllIssues() {
            addResult('Auto-Fix Started', 'info', 'Attempting to fix common issues...');
            
            // Clear any bad sessions
            localStorage.clear();
            sessionStorage.clear();
            
            // Sign out from Supabase
            try {
                await supabase.auth.signOut();
                addResult('Session Cleanup', 'success', 'Cleared all sessions');
            } catch (error) {
                addResult('Session Cleanup', 'warning', 'Session cleanup had issues', error.message);
            }
            
            // Test connection again
            await testConnection();
            
            addResult('Auto-Fix Complete', 'success', 'Basic fixes applied. Run diagnostic again to verify.');
        }

        function clearResults() {
            results.innerHTML = '';
            dataView.innerHTML = '';
        }

        // Auto-run diagnostic on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('Page Loaded', 'info', 'Supabase diagnostic tool ready. Click "Run Full Diagnostic" to start.');
            }, 500);
        });
    </script>
</body>
</html>